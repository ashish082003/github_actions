name: Comment Summary on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  comment-summary:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Run Python script
        id: run_script
        run: |
          output=$(python .github/scripts/test.py)
          echo "json_output=$output" >> $GITHUB_OUTPUT

      - name: Prepare markdown for all summaries
        id: prepare_comment
        run: |
          json='${{ steps.run_script.outputs.json_output }}'

          # Correct path: .summary.summary
          count=$(echo "$json" | jq '.summary.summary | length')

          for i in $(seq 0 $((count - 1))); do
            key1=$(echo "$json" | jq -r ".summary.summary[$i].key1")
            key2=$(echo "$json" | jq -r ".summary.summary[$i].key2")
            key3=$(echo "$json" | jq -r ".summary.summary[$i].key3")
            key4=$(echo "$json" | jq -r ".summary.summary[$i].key4")

              markdown+="\n\n#### ðŸ”¹ File: \`$key1\`
            - **key2:** $key2  
            - **key3:** $key3  
            - **key4:** $key4"
          done

          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$markdown" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on Pull Request
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "$markdown"

